# 페이지 레이아웃 (Page Layout)

## 개요

데이터베이스의 기본 I/O 단위는 **페이지(Page)**다. 디스크와 메모리 간 데이터 전송은 페이지 단위로 이루어지며, 페이지 내부의 레이아웃 설계는 저장 효율성과 접근 성능에 직접적인 영향을 미친다. 이 문서에서는 페이지 구조, 튜플 레이아웃, 가변 길이 데이터 처리 방식을 다룬다.

## 핵심 개념

### 1. 페이지의 기본 구조

```
┌─────────────────────────────────────────────────────────────┐
│                       Page (4KB - 16KB)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    Page Header                          ││
│  │  - Page ID                                              ││
│  │  - LSN (Log Sequence Number)                            ││
│  │  - Checksum                                             ││
│  │  - Free Space Info                                      ││
│  │  - Slot Count                                           ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    Slot Array                           ││
│  │  [offset1, len1] [offset2, len2] [offset3, len3] ...    ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                                                         ││
│  │                    Free Space                           ││
│  │                                                         ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    Tuple Data                           ││
│  │  (grows upward from bottom)                             ││
│  │  [Tuple 3] [Tuple 2] [Tuple 1]                          ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 2. Slotted Page 구조

가장 널리 사용되는 페이지 레이아웃 방식이다.

```
┌─────────────────────────────────────────────────────────────┐
│                    Slotted Page                              │
├─────────────────────────────────────────────────────────────┤
│ Header                                                       │
│ ┌──────┬──────┬──────┬──────┬──────┐                        │
│ │Slot 0│Slot 1│Slot 2│Slot 3│ ...  │  ← Slot array (위→아래)│
│ └──────┴──────┴──────┴──────┴──────┘                        │
│ ↓                                                           │
│                                                             │
│         [ Free Space ]                                      │
│                                                             │
│                                        ↑                    │
│ ┌──────────────────────────────────────────────────────────┐│
│ │      │      │      │      │                              ││
│ │Tup 3 │Tup 2 │Tup 1 │Tup 0 │  ← Tuple data (아래→위)      ││
│ └──────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘

Slot: [offset, length] 또는 [offset, flags]
- offset: 페이지 내 튜플 시작 위치
- length: 튜플 크기 또는 상태 플래그

장점:
- 튜플 이동 시 외부 참조(page_id, slot_id) 유지
- 가변 길이 튜플 효율적 관리
- 페이지 내 compaction 가능
```

**튜플 식별자 (TID / RID):**

```
TID = (page_id, slot_number)

예: (42, 3) = 42번 페이지의 3번 슬롯

인덱스 → TID → 페이지 → 슬롯 → 튜플
```

### 3. 튜플 레이아웃 (Tuple Layout)

```
┌─────────────────────────────────────────────────────────────┐
│                    Tuple Structure                           │
├─────────────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────────────┐   │
│ │                   Tuple Header                         │   │
│ │  - Visibility info (xmin, xmax for MVCC)              │   │
│ │  - NULL bitmap                                        │   │
│ │  - Column count                                       │   │
│ └───────────────────────────────────────────────────────┘   │
│ ┌───────────────────────────────────────────────────────┐   │
│ │                   Fixed-length columns                 │   │
│ │  [col1: 4B] [col2: 8B] [col3: 4B] ...                 │   │
│ └───────────────────────────────────────────────────────┘   │
│ ┌───────────────────────────────────────────────────────┐   │
│ │                   Variable-length columns              │   │
│ │  [len1][data1] [len2][data2] ...                      │   │
│ │  또는 offset array + 데이터                            │   │
│ └───────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**NULL 처리:**

```
NULL Bitmap: 각 컬럼의 NULL 여부를 비트로 표시

컬럼 5개: name(varchar), age(int), email(varchar), dept_id(int), salary(decimal)
NULL 비트맵: 0b01010 (age, dept_id가 NULL)

- NULL 컬럼은 데이터 영역에 공간 차지 안 함
- 비트맵으로 빠른 NULL 체크
```

### 4. 가변 길이 레코드 처리

```sql
CREATE TABLE users (
    id INT,                    -- 고정 4B
    name VARCHAR(100),         -- 가변 (최대 100B)
    bio TEXT,                  -- 가변 (큰 텍스트)
    profile_image BYTEA        -- 가변 (바이너리)
);
```

**방법 1: 오프셋 배열**

```
┌─────────────────────────────────────────────────────────────┐
│ Header │ Offset[0] │ Offset[1] │ Offset[2] │ Data Area      │
├─────────────────────────────────────────────────────────────┤
│        │    24     │    45     │    78     │ [col0][col1][col2]
└─────────────────────────────────────────────────────────────┘

- 컬럼 접근: O(1) - 오프셋에서 바로 위치 계산
- 오버헤드: 컬럼당 2-4B
```

**방법 2: 길이 프리픽스**

```
┌─────────────────────────────────────────────────────────────┐
│ Header │ [len1][data1] │ [len2][data2] │ [len3][data3]       │
└─────────────────────────────────────────────────────────────┘

- N번째 컬럼 접근: O(N) - 앞 컬럼들 순회 필요
- 오버헤드: 컬럼당 1-4B (길이 필드)
```

### 5. 대용량 값 처리 (TOAST / Overflow)

페이지 크기를 초과하는 값 처리:

```
┌─────────────────────────────────────────────────────────────┐
│                PostgreSQL TOAST                              │
├─────────────────────────────────────────────────────────────┤
│ 전략:                                                        │
│ 1. PLAIN: 압축/외부저장 안 함 (작은 고정 타입)              │
│ 2. EXTENDED: 압축 후 필요시 외부 저장 (기본값)              │
│ 3. EXTERNAL: 압축 없이 외부 저장                            │
│ 4. MAIN: 압축만, 외부 저장은 최후 수단                      │
│                                                             │
│ 동작:                                                        │
│ - 튜플이 페이지의 1/4(약 2KB) 초과 시 TOAST 동작           │
│ - 큰 값을 압축                                              │
│ - 그래도 크면 별도 TOAST 테이블에 저장                      │
│ - 원본 튜플에는 포인터만 저장                               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│            MySQL InnoDB Overflow Pages                       │
├─────────────────────────────────────────────────────────────┤
│ ROW_FORMAT에 따라 다름:                                      │
│                                                             │
│ COMPACT/DYNAMIC:                                             │
│ - 768B까지 인라인 저장                                       │
│ - 초과분은 overflow page에 저장                             │
│ - DYNAMIC: 큰 컬럼은 20B 포인터만 저장                      │
│                                                             │
│ COMPRESSED:                                                  │
│ - 페이지 압축 + overflow 분리                               │
└─────────────────────────────────────────────────────────────┘
```

### 6. PostgreSQL 페이지 구조

```
┌─────────────────────────────────────────────────────────────┐
│           PostgreSQL Page (기본 8KB)                         │
├─────────────────────────────────────────────────────────────┤
│ PageHeaderData (24 bytes)                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ pd_lsn        : 8B  - 마지막 WAL LSN                    │ │
│ │ pd_checksum   : 2B  - 페이지 체크섬                     │ │
│ │ pd_flags      : 2B  - 플래그                            │ │
│ │ pd_lower      : 2B  - 빈공간 시작 (슬롯 끝)             │ │
│ │ pd_upper      : 2B  - 빈공간 끝 (튜플 시작)             │ │
│ │ pd_special    : 2B  - 특수 영역 시작                    │ │
│ │ pd_pagesize_version : 2B                                │ │
│ │ pd_prune_xid  : 4B  - 가장 오래된 prunable xid          │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ItemIdData array (각 4 bytes)                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [lp_off:15][lp_flags:2][lp_len:15] ...                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                    Free Space                                │
│                                                             │
│ Tuple Data (HeapTupleHeaderData + user data)                 │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ t_xmin, t_xmax, t_cid, t_ctid, t_infomask, ...         │ │
│ │ NULL bitmap (optional)                                  │ │
│ │ User columns                                            │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ Special Space (B-tree, GiST 등에서 사용)                     │
└─────────────────────────────────────────────────────────────┘
```

### 7. MySQL InnoDB 페이지 구조

```
┌─────────────────────────────────────────────────────────────┐
│           InnoDB Page (기본 16KB)                            │
├─────────────────────────────────────────────────────────────┤
│ FIL Header (38 bytes)                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ FIL_PAGE_SPACE_OR_CHKSUM : 4B                           │ │
│ │ FIL_PAGE_OFFSET          : 4B  - 페이지 번호            │ │
│ │ FIL_PAGE_PREV            : 4B  - 이전 페이지            │ │
│ │ FIL_PAGE_NEXT            : 4B  - 다음 페이지            │ │
│ │ FIL_PAGE_LSN             : 8B                           │ │
│ │ FIL_PAGE_TYPE            : 2B                           │ │
│ │ ...                                                     │ │
│ └─────────────────────────────────────────────────────────┘ │
│ Page Header (56 bytes)                                       │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ PAGE_N_DIR_SLOTS, PAGE_HEAP_TOP, PAGE_FREE, ...        │ │
│ └─────────────────────────────────────────────────────────┘ │
│ Infimum + Supremum Records (26 bytes)                        │
│ User Records (가변)                                          │
│ Free Space                                                   │
│ Page Directory (가변)                                        │
│ FIL Trailer (8 bytes)                                        │
└─────────────────────────────────────────────────────────────┘

InnoDB 특징:
- B+Tree 기반: 데이터 페이지가 리프 노드
- Clustered Index: PK 순서로 저장
- Page Directory: 이진 검색을 위한 슬롯
```

### 8. 페이지 크기 선택

```
┌─────────────────────────────────────────────────────────────┐
│ 페이지 크기 트레이드오프                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 작은 페이지 (4KB)                                           │
│ ✓ 메모리 효율 (필요한 데이터만 캐싱)                        │
│ ✓ 동시성 (잠금 경합 감소)                                   │
│ ✗ I/O 횟수 증가                                             │
│ ✗ 큰 레코드 저장 제한                                       │
│                                                             │
│ 큰 페이지 (16KB, 32KB)                                      │
│ ✓ Sequential I/O 효율                                       │
│ ✓ 큰 레코드 저장 용이                                       │
│ ✓ 인덱스 팬아웃 증가                                        │
│ ✗ 메모리 낭비 가능                                          │
│ ✗ 부분 업데이트 시 전체 페이지 쓰기                         │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ 권장:                                                        │
│ - PostgreSQL: 8KB (기본, 컴파일 시 변경 가능)               │
│ - MySQL InnoDB: 16KB (기본, innodb_page_size로 변경)        │
│ - 대부분의 워크로드에 기본값이 적합                         │
└─────────────────────────────────────────────────────────────┘
```

## 실무 적용

### 페이지 Bloat 모니터링

```sql
-- PostgreSQL: 테이블 bloat 확인
SELECT
    schemaname, tablename,
    pg_size_pretty(pg_total_relation_size(schemaname || '.' || tablename)) as size,
    round(100 * pg_total_relation_size(schemaname || '.' || tablename) /
          nullif(pg_total_relation_size(schemaname || '.' || tablename), 0)::numeric, 2) as bloat_pct
FROM pg_tables
WHERE schemaname = 'public';

-- 확장: pgstattuple 사용
CREATE EXTENSION pgstattuple;
SELECT * FROM pgstattuple('mytable');
-- dead_tuple_percent가 높으면 VACUUM 필요
```

### TOAST 확인

```sql
-- PostgreSQL: TOAST 테이블 크기 확인
SELECT
    c.relname AS table_name,
    pg_size_pretty(pg_relation_size(c.oid)) AS main_size,
    pg_size_pretty(pg_relation_size(c.reltoastrelid)) AS toast_size
FROM pg_class c
WHERE c.relkind = 'r' AND c.reltoastrelid != 0;
```

## 참고 자료

- PostgreSQL Documentation: Database Physical Storage
- MySQL Documentation: InnoDB Page Structure
- "Database Internals" (Petrov) - Chapter 3
- CMU 15-445: Database Storage
